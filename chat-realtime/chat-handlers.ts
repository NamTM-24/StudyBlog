import { Server, Socket } from 'socket.io';
import { ChatService } from '../services/chat.service.js';
import { chatUsers, chatMessages, adminSockets } from './chat-models.js';
import type { ChatMessage, ChatUser } from '../types/chat.types.js';
import type { JwtPayload } from '../types/auth.types.js';
import { jwtSecret } from '../utils/jwt.utils.js';
import jwt from 'jsonwebtoken';
import { prisma } from '../config/database.js';

export function setupChatHandlers(io: Server) {
    io.on('connection', (socket: Socket) => {
        console.log('User connected:', socket.id);

        // X·ª≠ l√Ω user join chat
        socket.on('join-chat', async (data: { token?: string }) => {
            try {
                let user: any = null;
                let isAdmin = false;

                if (data.token) {
                    try {
                        const decoded = jwt.verify(data.token, jwtSecret) as JwtPayload;
                        user = await prisma.user.findUnique({
                            where: { id: decoded.id },
                            select: { id: true, name: true, email: true, avatar: true, role: true }
                        });
                        isAdmin = user?.role === 'ADMIN';
                    } catch (error) {
                        console.log('Token verification failed for chat:', error);
                    }
                }

                const chatUser: ChatUser = {
                    id: socket.id,
                    userId: user?.id,
                    userName: user?.name || 'Kh√°ch',
                    userAvatar: user?.avatar,
                    isAdmin,
                    socketId: socket.id
                };

                chatUsers.set(socket.id, chatUser);

                // T·∫°o chat room ri√™ng cho user
                const chatRoomId = isAdmin ? 'admin' : `user-${chatUser.userId || socket.id}`;
                console.log('Chat room created:', chatRoomId, 'for user:', chatUser.userName, 'isAdmin:', isAdmin);

                // Kh·ªüi t·∫°o chat messages cho user n·∫øu ch∆∞a c√≥
                if (!chatMessages.has(chatRoomId)) {
                    chatMessages.set(chatRoomId, []);
                    console.log('New chat room initialized:', chatRoomId);
                }

                // Join v√†o room ri√™ng
                socket.join(chatRoomId);

                // L∆∞u admin socket v√† join v√†o t·∫•t c·∫£ user rooms
                if (isAdmin) {
                    adminSockets.add(socket.id);
                    console.log('=== ADMIN JOIN DEBUG ===');
                    console.log('Admin joined, socket ID:', socket.id);
                    console.log('Total admin sockets:', adminSockets.size);
                    console.log('Admin sockets:', Array.from(adminSockets));

                    // Admin join v√†o room admin ƒë·ªÉ nh·∫≠n th√¥ng b√°o
                    socket.join('admin');
                    console.log('Admin joined room "admin"');
                    console.log('=== END ADMIN JOIN DEBUG ===');
                }

                // G·ª≠i th√¥ng b√°o ch√†o m·ª´ng ch·ªâ khi user kh√¥ng ph·∫£i admin v√† ch∆∞a c√≥ tin nh·∫Øn ch√†o m·ª´ng
                if (!isAdmin) {
                    const userMessages = chatMessages.get(chatRoomId) || [];
                    const hasWelcomeMessage = userMessages.some(msg => msg.isSystem && msg.isAdmin);

                    if (!hasWelcomeMessage) {
                        const welcomeMessage: ChatMessage = {
                            id: `welcome-${Date.now()}`,
                            message: `Xin ch√†o ${chatUser.userName}! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n nh∆∞ th·∫ø n√†o?`,
                            timestamp: new Date(),
                            isAdmin: true,
                            isSystem: true
                        };

                        // Th√™m tin nh·∫Øn ch√†o m·ª´ng v√†o chat room
                        userMessages.push(welcomeMessage);
                        chatMessages.set(chatRoomId, userMessages);

                        socket.emit('chat-message', welcomeMessage);
                    }
                }

                // Load tin nh·∫Øn t·ª´ database v√† g·ª≠i l·ªãch s·ª≠ chat
                const dbMessages = await ChatService.loadChatMessagesFromDatabase(chatRoomId, 50);
                const userMessages = chatMessages.get(chatRoomId) || [];

                // Merge database messages v·ªõi memory messages
                const allMessages = [...dbMessages, ...userMessages];
                chatMessages.set(chatRoomId, allMessages);

                socket.emit('chat-history', {
                    chatRoomId: chatRoomId,
                    messages: allMessages.slice(-50)
                }); // G·ª≠i 50 tin nh·∫Øn g·∫ßn nh·∫•t

                // Th√¥ng b√°o user online cho admin
                if (!isAdmin) {
                    // G·ª≠i th√¥ng b√°o cho t·∫•t c·∫£ admin online
                    adminSockets.forEach(adminSocketId => {
                        io.to(adminSocketId).emit('user-online', {
                            userId: chatUser.userId,
                            userName: chatUser.userName,
                            userAvatar: chatUser.userAvatar,
                            chatRoomId: chatRoomId
                        });
                    });
                }
            } catch (error) {
                console.error('Error joining chat:', error);
            }
        });

        // X·ª≠ l√Ω tin nh·∫Øn chat
        socket.on('send-message', async (data: { message: string, token?: string, targetUserId?: string }) => {
            try {
                const chatUser = chatUsers.get(socket.id);
                if (!chatUser) return;

                let chatRoomId: string;

                if (chatUser.isAdmin) {
                    // N·∫øu admin g·ª≠i tin nh·∫Øn, c·∫ßn targetUserId
                    console.log('Admin sending message, data:', data);
                    console.log('Admin user:', chatUser);

                    if (!data.targetUserId) {
                        console.error('Admin message missing targetUserId');
                        console.error('Data received:', data);
                        return;
                    }
                    chatRoomId = `user-${data.targetUserId}`;
                    console.log('Admin target room:', chatRoomId);

                    // Admin join v√†o room c·ªßa user ƒë·ªÉ c√≥ th·ªÉ g·ª≠i tin nh·∫Øn
                    socket.join(chatRoomId);
                    console.log('Admin joined room:', chatRoomId);

                    // ƒê·∫£m b·∫£o room t·ªìn t·∫°i
                    if (!chatMessages.has(chatRoomId)) {
                        chatMessages.set(chatRoomId, []);
                    }
                } else {
                    // N·∫øu user g·ª≠i tin nh·∫Øn, t·∫°o room cho user ƒë√≥
                    chatRoomId = `user-${chatUser.userId || socket.id}`;
                }

                const newMessage: ChatMessage = {
                    id: `msg-${Date.now()}-${Math.random()}`,
                    userId: chatUser.userId,
                    userName: chatUser.userName,
                    userAvatar: chatUser.userAvatar,
                    message: data.message.trim(),
                    timestamp: new Date(),
                    isAdmin: chatUser.isAdmin
                };

                // L∆∞u tin nh·∫Øn v√†o database
                if (chatUser.userId) {
                    console.log('üíæ Saving message to database:', {
                        roomId: chatRoomId,
                        userId: chatUser.userId,
                        message: newMessage.message,
                        isAdmin: newMessage.isAdmin
                    });
                    await ChatService.saveChatMessageToDatabase(chatRoomId, chatUser.userId, newMessage.message, newMessage.isAdmin);
                } else {
                    console.log('‚ö†Ô∏è Cannot save message to database: no userId');
                }

                // Th√™m tin nh·∫Øn v√†o chat room c·ªßa user (memory cache)
                const userMessages = chatMessages.get(chatRoomId) || [];
                userMessages.push(newMessage);
                chatMessages.set(chatRoomId, userMessages);

                // G·ª≠i tin nh·∫Øn ƒë·∫øn room ri√™ng - G·ª≠i cho t·∫•t c·∫£ trong room ƒë√≥ (bao g·ªìm c·∫£ sender)
                io.to(chatRoomId).emit('chat-message', newMessage);
                console.log('Message sent to room:', chatRoomId);
                console.log('Message content:', newMessage);
                console.log('Room members:', Array.from(io.sockets.adapter.rooms.get(chatRoomId) || []));

                // N·∫øu l√† tin nh·∫Øn t·ª´ admin, ƒë·∫£m b·∫£o user nh·∫≠n ƒë∆∞·ª£c
                if (chatUser.isAdmin) {
                    console.log('Admin message sent, ensuring user receives it');
                }

                // N·∫øu l√† tin nh·∫Øn t·ª´ user (kh√¥ng ph·∫£i admin), g·ª≠i th√¥ng b√°o cho admin
                if (!chatUser.isAdmin) {
                    console.log('=== USER MESSAGE DEBUG ===');
                    console.log('User message sent to room:', chatRoomId);
                    console.log('Admin sockets count:', adminSockets.size);

                    // Ch·ªâ g·ª≠i th√¥ng b√°o ƒë·∫øn room admin, kh√¥ng g·ª≠i chat-message
                    // Admin s·∫Ω nh·∫≠n chat-message khi join v√†o room c·ªßa user
                    io.to('admin').emit('new-user-message', {
                        userId: chatUser.userId,
                        userName: chatUser.userName,
                        userAvatar: chatUser.userAvatar,
                        message: data.message,
                        chatRoomId: chatRoomId
                    });

                    console.log('=== END USER MESSAGE DEBUG ===');
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        });

        // X·ª≠ l√Ω admin join v√†o room c·ªßa user
        socket.on('join-user-room', (data: { chatRoomId: string }) => {
            const chatUser = chatUsers.get(socket.id);
            if (chatUser && chatUser.isAdmin) {
                socket.join(data.chatRoomId);
                console.log('Admin joined user room:', data.chatRoomId);
            }
        });

        // X·ª≠ l√Ω request chat history
        socket.on('request-chat-history', async (data: { chatRoomId?: string, token?: string }) => {
            const chatUser = chatUsers.get(socket.id);
            if (!chatUser) {
                console.log('No chat user found for socket:', socket.id);
                return;
            }

            if (chatUser.isAdmin && data.chatRoomId) {
                // Admin requesting specific room history
                console.log('Admin requesting chat history for room:', data.chatRoomId);

                // Load tin nh·∫Øn t·ª´ database
                const dbMessages = await ChatService.loadChatMessagesFromDatabase(data.chatRoomId, 50);
                const userMessages = chatMessages.get(data.chatRoomId) || [];

                // Merge database messages v·ªõi memory messages
                const allMessages = [...dbMessages, ...userMessages];
                chatMessages.set(data.chatRoomId, allMessages);

                socket.emit('chat-history', {
                    chatRoomId: data.chatRoomId,
                    messages: allMessages.slice(-50)
                });

                console.log(`Sent ${allMessages.length} messages to admin for room:`, data.chatRoomId);
            } else if (!chatUser.isAdmin) {
                // User requesting their own chat history
                const userRoomId = `user-${chatUser.userId}`;
                console.log('User requesting chat history for room:', userRoomId);

                // Load tin nh·∫Øn t·ª´ database
                const dbMessages = await ChatService.loadChatMessagesFromDatabase(userRoomId, 50);
                const userMessages = chatMessages.get(userRoomId) || [];

                // Merge database messages v·ªõi memory messages
                const allMessages = [...dbMessages, ...userMessages];
                chatMessages.set(userRoomId, allMessages);

                socket.emit('chat-history', {
                    chatRoomId: userRoomId,
                    messages: allMessages.slice(-50)
                });

                console.log(`Sent ${allMessages.length} messages to user for room:`, userRoomId);
            }
        });

        // X·ª≠ l√Ω admin g·ª≠i tin nh·∫Øn tr·ª±c ti·∫øp ƒë·∫øn user widget
        socket.on('admin-direct-message', (data: { targetUserId: string, message: string, adminName: string }) => {
            const chatUser = chatUsers.get(socket.id);
            if (chatUser && chatUser.isAdmin) {
                console.log('Admin sending direct message to user widget:', data.targetUserId);

                // Validate data
                if (!data.targetUserId || !data.message || !data.adminName) {
                    console.error('Invalid admin-direct-message data:', data);
                    return;
                }

                // T√¨m user socket v√† g·ª≠i tin nh·∫Øn ƒë·∫øn widget
                let userFound = false;
                for (const [socketId, user] of chatUsers.entries()) {
                    if (user.userId?.toString() === data.targetUserId && !user.isAdmin) {
                        console.log('Sending admin message to user widget:', socketId);
                        io.to(socketId).emit('admin-message', {
                            message: data.message,
                            adminName: data.adminName,
                            timestamp: new Date()
                        });
                        userFound = true;
                        break;
                    }
                }

                if (!userFound) {
                    console.log('Target user not found or not online:', data.targetUserId);
                }
            }
        });

        // X·ª≠ l√Ω typing indicator
        socket.on('typing', (data: { isTyping: boolean }) => {
            const chatUser = chatUsers.get(socket.id);
            if (chatUser) {
                let chatRoomId: string;

                if (chatUser.isAdmin) {
                    // Admin typing - c·∫ßn g·ª≠i ƒë·∫øn room c·ªßa user hi·ªán t·∫°i
                    // ƒêi·ªÅu n√†y s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü client side
                    return;
                } else {
                    chatRoomId = `user-${chatUser.userId || socket.id}`;
                }

                socket.to(chatRoomId).emit('user-typing', {
                    userId: chatUser.userId,
                    userName: chatUser.userName,
                    isTyping: data.isTyping
                });
            }
        });

        // X·ª≠ l√Ω request users with messages
        socket.on('request-users-with-messages', async () => {
            const chatUser = chatUsers.get(socket.id);
            if (chatUser && chatUser.isAdmin) {
                console.log('Admin requesting users with messages');

                try {
                    const users = await ChatService.getUsersWithMessages();
                    socket.emit('users-with-messages', users);
                    console.log(`Sent ${users.length} users with messages to admin`);
                } catch (error) {
                    console.error('Error getting users with messages:', error);
                }
            }
        });

        // Test admin connection
        socket.on('test-admin-connection', (data) => {
            const chatUser = chatUsers.get(socket.id);
            if (chatUser && chatUser.isAdmin) {
                console.log('=== ADMIN CONNECTION TEST ===');
                console.log('Admin test connection received:', data);
                console.log('Admin socket ID:', socket.id);
                console.log('Admin in adminSockets:', adminSockets.has(socket.id));
                console.log('Total admin sockets:', adminSockets.size);
                console.log('Admin user data:', chatUser);
                console.log('=== END ADMIN CONNECTION TEST ===');

                // Send confirmation back to admin
                socket.emit('admin-connection-confirmed', {
                    message: 'Admin connection confirmed',
                    socketId: socket.id,
                    adminSocketsCount: adminSockets.size,
                    timestamp: new Date().toISOString()
                });
            }
        });

        // X·ª≠ l√Ω disconnect
        socket.on('disconnect', () => {
            const chatUser = chatUsers.get(socket.id);
            if (chatUser) {
                chatUsers.delete(socket.id);

                // X√≥a admin socket n·∫øu l√† admin
                if (chatUser.isAdmin) {
                    adminSockets.delete(socket.id);
                }

                // Th√¥ng b√°o user offline cho admin
                if (!chatUser.isAdmin) {
                    // G·ª≠i th√¥ng b√°o cho t·∫•t c·∫£ admin online
                    adminSockets.forEach(adminSocketId => {
                        io.to(adminSocketId).emit('user-offline', {
                            userId: chatUser.userId,
                            userName: chatUser.userName,
                            userAvatar: chatUser.userAvatar
                        });
                    });
                }
            }
            console.log('User disconnected:', socket.id);
        });
    });
}
