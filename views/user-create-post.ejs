<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/output.css" />
    <title>Tạo bài viết mới - User</title>

    <script>
      document.head.insertAdjacentHTML(
        "afterbegin",
        '<link rel="stylesheet" type="text/css" href="https://unpkg.com/flowbite-typography@1.0.3/dist/typography.min.css">'
      );
    </script>

    <!-- Quill Editor CSS -->
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#eff6ff",
                100: "#dbeafe",
                200: "#bfdbfe",
                300: "#93c5fd",
                400: "#60a5fa",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                800: "#1e40af",
                900: "#1e3a8a",
                950: "#172554",
              },
            },
          },
          fontFamily: {
            body: [
              "Inter",
              "ui-sans-serif",
              "system-ui",
              "-apple-system",
              "system-ui",
              "Segoe UI",
              "Roboto",
              "Helvetica Neue",
              "Arial",
              "Noto Sans",
              "sans-serif",
              "Apple Color Emoji",
              "Segoe UI Emoji",
              "Segoe UI Symbol",
              "Noto Color Emoji",
            ],
            sans: [
              "Inter",
              "ui-sans-serif",
              "system-ui",
              "-apple-system",
              "system-ui",
              "Segoe UI",
              "Roboto",
              "Helvetica Neue",
              "Arial",
              "Noto Sans",
              "sans-serif",
              "Apple Color Emoji",
              "Segoe UI Emoji",
              "Segoe UI Symbol",
              "Noto Color Emoji",
            ],
          },
        },
      };
    </script>

    <style>
      .ql-editor {
        font-size: 16px;
        line-height: 1.6;
        min-height: 400px;
      }

      .ql-editor h1 {
        font-size: 2.5rem !important;
        font-weight: 700 !important;
        margin: 1.5rem 0 1rem 0 !important;
        color: #1e293b !important;
        display: block !important;
        line-height: 1.2 !important;
      }

      .upload-progress {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #3b82f6;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .upload-progress.show {
        display: block;
      }
    </style>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <header
      class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700"
    >
      <nav class="px-4 lg:px-6 py-2.5">
        <div
          class="flex flex-wrap justify-between items-center mx-auto max-w-screen-xl"
        >
          <a href="/" class="flex items-center">
            <img
              src="/images/weaverseio_logo.jpg"
              class="mr-3 h-6 sm:h-9"
              alt="StudyBlog Logo"
            />
            <span
              class="self-center text-xl font-semibold whitespace-nowrap dark:text-white"
              >StudyBlog</span
            >
          </a>

          <div class="flex items-center lg:order-2">
            <% if (user) { %>
            <div class="relative">
              <button
                type="button"
                id="user-menu-button"
                class="flex text-sm bg-gray-800 rounded-full md:me-0 focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600"
              >
                <% if (user.avatar) { %>
                <img
                  class="w-8 h-8 rounded-full"
                  src="<%= user.avatar %>"
                  alt="User Avatar"
                />
                <% } else { %>
                <div
                  class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-white font-semibold"
                >
                  <%= user.name.charAt(0).toUpperCase() %>
                </div>
                <% } %>
              </button>

              <div
                class="hidden absolute right-0 mt-2 bg-white dark:bg-gray-700 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600 z-50"
                id="user-dropdown"
                style="min-width: 200px"
              >
                <div class="px-4 py-3">
                  <span class="block text-sm text-gray-900 dark:text-white"
                    ><%= user.name %></span
                  >
                  <span
                    class="block text-sm text-gray-500 truncate dark:text-gray-400"
                    ><%= user.email %></span
                  >
                </div>
                <ul class="py-2" aria-labelledby="user-menu-button">
                  <li>
                    <a
                      href="/posts/user/manage"
                      class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white"
                    >
                      <svg
                        class="w-4 h-4 inline mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        ></path>
                      </svg>
                      Quản lý bài viết
                    </a>
                  </li>
                  <li>
                    <a
                      href="/logout"
                      class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white"
                    >
                      <svg
                        class="w-4 h-4 inline mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        ></path>
                      </svg>
                      Đăng xuất
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <% } %>
          </div>

          <div
            class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1"
            id="navbar-user"
          >
            <ul
              class="flex flex-col font-medium p-4 md:p-0 mt-4 border border-gray-100 rounded-lg bg-gray-50 md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700"
            >
              <li>
                <a
                  href="/home"
                  class="block py-2 px-3 text-gray-900 rounded-sm hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700"
                  >Trang chủ</a
                >
              </li>
              <li>
                <a
                  href="/posts"
                  class="block py-2 px-3 text-gray-900 rounded-sm hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700"
                  >Bài viết</a
                >
              </li>
              <li>
                <a
                  href="/posts/create/new"
                  class="block py-2 px-3 text-blue-600 rounded-sm hover:bg-blue-50 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 dark:text-blue-500 md:dark:hover:text-blue-400 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700"
                  >Viết bài</a
                >
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Upload Progress -->
    <div id="uploadProgress" class="upload-progress">
      <div class="flex items-center gap-2">
        <div
          class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"
        ></div>
        <span>Đang tải ảnh lên...</span>
      </div>
    </div>

    <!-- MID -->
    <main class="pb-16 lg:pb-24 bg-white dark:bg-gray-900 antialiased">
      <header
        class="bg-[url('https://flowbite.s3.amazonaws.com/blocks/marketing-ui/articles/background.png')] w-full h-[460px] xl:h-[537px] bg-no-repeat bg-cover bg-center bg-blend-darken relative"
      >
        <div
          class="absolute top-0 left-0 w-full h-full bg-black bg-opacity-50"
        ></div>
        <div
          class="absolute top-20 left-1/2 px-4 mx-auto w-full max-w-screen-xl -translate-x-1/2 xl:top-1/2 xl:-translate-y-1/2 xl:px-0"
        >
          <span class="block mb-4 text-gray-300">Tạo bài viết mới</span>
          <h1
            class="mb-4 max-w-4xl text-2xl font-extrabold leading-none text-white sm:text-3xl lg:text-4xl"
          >
            Chia sẻ kiến thức với cộng đồng
          </h1>
          <p class="text-lg font-normal text-gray-300">
            Bài viết của bạn sẽ được xuất bản ngay lập tức
          </p>
        </div>
      </header>

      <div
        class="flex relative z-20 justify-between p-6 -m-36 mx-4 max-w-screen-xl bg-white dark:bg-gray-800 rounded xl:-m-32 xl:p-9 xl:mx-auto"
      >
        <!-- Error Message -->
        <% if (typeof error !== 'undefined' && error) { %>
        <div
          class="mb-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl"
        >
          <strong>Lỗi!</strong> <%= error %>
        </div>
        <% } %>

        <article
          class="xl:w-[828px] w-full max-w-none format format-sm sm:format-base lg:format-lg format-blue dark:format-invert"
        >
          <!-- Title Input -->
          <div class="mb-8">
            <textarea
              id="titleInput"
              placeholder="Viết tiêu đề bài viết của bạn..."
              class="title-input w-full text-4xl md:text-5xl font-bold bg-transparent border-none outline-none resize-none placeholder-slate-400 dark:placeholder-slate-600 leading-tight"
              rows="2"
            ></textarea>
          </div>

          <!-- Content Editor -->
          <div class="mb-8">
            <div id="editor"></div>
          </div>

          <!-- Article Preview Section -->
          <div id="articlePreview" class="mb-8 hidden">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
              <h3
                class="text-lg font-semibold mb-4 text-gray-900 dark:text-white"
              >
                Xem trước bài viết
              </h3>

              <!-- Article Header -->
              <div class="mb-6">
                <div
                  class="flex items-center space-x-3 text-gray-500 dark:text-gray-400 text-base mb-2"
                >
                  <span
                    >Tác giả
                    <span
                      class="text-gray-900 dark:text-white font-semibold"
                      id="previewAuthor"
                      >Đang tải...</span
                    ></span
                  >
                  <span
                    class="bg-gray-300 dark:bg-gray-400 w-2 h-2 rounded-full"
                  ></span>
                  <span
                    ><time
                      class="font-normal text-gray-500 dark:text-gray-400"
                      id="previewDate"
                      >Đang tải...</time
                    ></span
                  >
                </div>
                <h1
                  id="previewTitle"
                  class="text-2xl font-bold text-gray-900 dark:text-white mb-4"
                ></h1>
              </div>

              <!-- Article Content Preview -->
              <div
                id="previewContent"
                class="prose prose-sm max-w-none dark:prose-invert"
              ></div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex items-center gap-4 mt-8">
            <button
              id="publishBtn"
              class="px-6 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white dark:text-white font-semibold text-sm transition"
            >
              Gửi bài viết
            </button>
            <button
              id="previewBtn"
              class="px-6 py-2 rounded-xl border border-gray-300 hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-700 text-sm"
            >
              Xem trước
            </button>
          </div>

          <!-- Publish Form -->
          <form
            id="publishForm"
            method="POST"
            action="/posts/create/new"
            class="hidden"
          >
            <input type="hidden" id="formTitle" name="title" />
            <input type="hidden" id="formContent" name="content" />
          </form>
        </article>

        <!-- Sidebar -->
        <aside class="hidden xl:block xl:w-[364px]">
          <div class="sticky top-8">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
              <h3 class="text-lg font-semibold mb-4">Hướng dẫn viết bài</h3>
              <ul class="space-y-2 text-sm text-gray-600 dark:text-gray-300">
                <li>• Sử dụng H1, H2, H3 cho tiêu đề</li>
                <li>• In đậm, in nghiêng cho nhấn mạnh</li>
                <li>• Chèn ảnh bằng nút hình ảnh</li>
                <li>• Tạo danh sách có thứ tự</li>
                <li>• Sử dụng blockquote cho trích dẫn</li>
              </ul>
            </div>

            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6 mt-4">
              <h3
                class="text-lg font-semibold mb-4 text-blue-800 dark:text-blue-200"
              >
                Lưu ý quan trọng
              </h3>
              <ul class="space-y-2 text-sm text-blue-700 dark:text-blue-300">
                <li>• Bài viết sẽ được xuất bản ngay lập tức</li>
                <li>• Đảm bảo nội dung chất lượng và có ích</li>
                <li>• Không viết nội dung spam hoặc quảng cáo</li>
                <li>• Tuân thủ quy tắc cộng đồng</li>
              </ul>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <!-- Quill Editor JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
      // Auto-resize title input
      function autoResize(textarea) {
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
      }

      const titleInput = document.getElementById("titleInput");
      titleInput?.addEventListener("input", () => autoResize(titleInput));

      // Initialize Quill Editor
      const toolbarOptions = [
        [{ header: [1, 2, 3, false] }],
        ["bold", "italic", "underline", "strike"],
        [{ list: "ordered" }, { list: "bullet" }],
        [{ script: "sub" }, { script: "super" }],
        [{ indent: "-1" }, { indent: "+1" }],
        [{ direction: "rtl" }],
        [{ size: ["small", false, "large", "huge"] }],
        [{ color: [] }, { background: [] }],
        [{ font: [] }],
        [{ align: [] }],
        ["clean"],
        ["link", "image", "video", "code-block", "blockquote"],
      ];

      const quill = new Quill("#editor", {
        theme: "snow",
        modules: {
          toolbar: {
            container: toolbarOptions,
            handlers: {
              image: imageHandler,
            },
          },
        },
        placeholder: "Bắt đầu viết nội dung bài viết của bạn...",
      });

      // Custom image handler
      function imageHandler() {
        const input = document.createElement("input");
        input.setAttribute("type", "file");
        input.setAttribute("accept", "image/*");
        input.click();

        input.onchange = async () => {
          const file = input.files[0];
          if (file) {
            await uploadImage(file);
          }
        };
      }

      // Upload image function
      async function uploadImage(file) {
        const progress = document.getElementById("uploadProgress");
        progress.classList.add("show");

        const formData = new FormData();
        formData.append("image", file);

        try {
          const response = await fetch("/posts/upload-image", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            const result = await response.json();
            const range = quill.getSelection();
            quill.insertEmbed(range.index, "image", result.url);
            quill.setSelection(range.index + 1);
          } else {
            throw new Error("Upload failed");
          }
        } catch (error) {
          console.error("Upload error:", error);
          alert("Không thể tải ảnh lên. Vui lòng thử lại.");
        } finally {
          progress.classList.remove("show");
        }
      }

      // Get current user info
      let currentUser = null;

      // Fetch current user info
      async function fetchCurrentUser() {
        try {
          const response = await fetch("/api/current-user");
          if (response.ok) {
            currentUser = await response.json();
          }
        } catch (error) {
          console.error("Error fetching user:", error);
        }
      }

      // Preview functionality
      const previewBtn = document.getElementById("previewBtn");
      const articlePreview = document.getElementById("articlePreview");
      const previewTitle = document.getElementById("previewTitle");
      const previewContent = document.getElementById("previewContent");
      const previewAuthor = document.getElementById("previewAuthor");
      const previewDate = document.getElementById("previewDate");

      previewBtn?.addEventListener("click", () => {
        const title = titleInput?.value.trim();
        const content = quill.root.innerHTML;
        const textContent = quill.getText().trim();

        if (!title) {
          alert("Vui lòng nhập tiêu đề bài viết!");
          titleInput?.focus();
          return;
        }

        if (!textContent || textContent.length < 3) {
          alert("Vui lòng nhập nội dung bài viết!");
          quill.focus();
          return;
        }

        // Update preview
        previewTitle.textContent = title;
        previewContent.innerHTML = content;

        // Update author and date
        if (currentUser) {
          previewAuthor.textContent = currentUser.name || "Tác giả";
        } else {
          previewAuthor.textContent = "Tác giả";
        }

        const now = new Date();
        previewDate.textContent = now.toLocaleDateString("vi-VN", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

        // Show preview
        articlePreview.classList.remove("hidden");
        articlePreview.scrollIntoView({ behavior: "smooth" });
      });

      // Publish functionality
      const publishBtn = document.getElementById("publishBtn");
      const publishForm = document.getElementById("publishForm");

      publishBtn?.addEventListener("click", async () => {
        console.log("=== Publish button clicked ===");
        const title = titleInput?.value.trim();
        const content = quill.root.innerHTML;
        const textContent = quill.getText().trim();

        console.log("Title:", title);
        console.log("Content HTML length:", content ? content.length : 0);
        console.log(
          "Content text length:",
          textContent ? textContent.length : 0
        );
        console.log(
          "Content preview:",
          content ? content.substring(0, 100) + "..." : "empty"
        );

        if (!title) {
          alert("Vui lòng nhập tiêu đề bài viết!");
          titleInput?.focus();
          return;
        }

        if (!textContent || textContent.length < 3) {
          alert("Vui lòng nhập nội dung bài viết!");
          quill.focus();
          return;
        }

        // Show loading state
        publishBtn.disabled = true;
        publishBtn.textContent = "Đang gửi bài...";

        try {
          // Fill form data
          console.log("Setting form values...");
          document.getElementById("formTitle").value = title;
          document.getElementById("formContent").value = content;

          console.log("Form action:", publishForm.action);
          console.log("Form method:", publishForm.method);

          // Submit form
          console.log("Submitting form...");
          publishForm.submit();
        } catch (error) {
          console.error("Error publishing:", error);
          alert("Có lỗi xảy ra khi gửi bài. Vui lòng thử lại.");

          // Reset button state
          publishBtn.disabled = false;
          publishBtn.textContent = "Gửi bài viết";
        }
      });

      // Initialize
      autoResize(titleInput);

      // Fetch current user info on page load
      fetchCurrentUser();

      // User dropdown functionality
      (function () {
        const userMenuButton = document.getElementById("user-menu-button");
        const userDropdown = document.getElementById("user-dropdown");

        // Toggle dropdown
        if (userMenuButton && userDropdown) {
          userMenuButton.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            userDropdown.classList.toggle("hidden");
          });

          // Close dropdown when clicking outside
          window.addEventListener("click", (e) => {
            if (
              !userMenuButton.contains(e.target) &&
              !userDropdown.contains(e.target)
            ) {
              userDropdown.classList.add("hidden");
            }
          });
        }
      })();
    </script>
  </body>
</html>
