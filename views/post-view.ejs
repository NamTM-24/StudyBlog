<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/output.css" />
    <link rel="stylesheet" href="/css/chat-widget.css" />
    <title><%= post.title %> - StudyBlog</title>

    <script>
      document.head.insertAdjacentHTML(
        "afterbegin",
        '<link rel="stylesheet" type="text/css" href="https://unpkg.com/flowbite-typography@1.0.3/dist/typography.min.css">'
      );
    </script>

    <!-- Socket.IO Client -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#eff6ff",
                100: "#dbeafe",
                200: "#bfdbfe",
                300: "#93c5fd",
                400: "#60a5fa",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                800: "#1e40af",
                900: "#1e3a8a",
                950: "#172554",
              },
            },
          },
          fontFamily: {
            body: [
              "Inter",
              "ui-sans-serif",
              "system-ui",
              "-apple-system",
              "system-ui",
              "Segoe UI",
              "Roboto",
              "Helvetica Neue",
              "Arial",
              "Noto Sans",
              "sans-serif",
              "Apple Color Emoji",
              "Segoe UI Emoji",
              "Segoe UI Symbol",
              "Noto Color Emoji",
            ],
            sans: [
              "Inter",
              "ui-sans-serif",
              "system-ui",
              "-apple-system",
              "system-ui",
              "Segoe UI",
              "Roboto",
              "Helvetica Neue",
              "Arial",
              "Noto Sans",
              "sans-serif",
              "Apple Color Emoji",
              "Segoe UI Emoji",
              "Segoe UI Symbol",
              "Noto Color Emoji",
            ],
          },
        },
      };
    </script>

    <style>
      /* Đảm bảo modal hiển thị đúng */
      #avatar-modal {
        display: none;
      }

      #avatar-modal:not(.hidden) {
        display: block !important;
      }

      /* Đảm bảo các button trong modal hiển thị */
      #select-avatar-btn,
      #cancel-avatar-btn,
      #save-avatar-btn {
        display: inline-block !important;
      }

      /* Đảm bảo tất cả nội dung trong modal hiển thị */
      #avatar-modal .mt-3 {
        display: block !important;
      }

      #avatar-modal .mb-4 {
        display: block !important;
      }

      #avatar-modal .flex {
        display: flex !important;
      }

      /* Debug CSS cho avatar dropdown */
      #user-dropdown {
        z-index: 1000 !important;
        background: white !important;
        border: 1px solid #ccc !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
      }

      #user-dropdown:not(.hidden) {
        display: block !important;
      }

      #user-menu-button {
        z-index: 999 !important;
      }
    </style>
  </head>

  <body>
    <header class="">
      <nav class="bg-gray-900 border-gray-200">
        <div
          class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4"
        >
          <a href="/" class="flex items-center space-x-3 rtl:space-x-reverse">
            <img src="/images/weaverseio_logo.jpg" class="h-8" alt="" />
            <span
              class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white text-white"
              >StudyBlog</span
            >
          </a>

          <div
            class="flex items-center md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse gap-5"
          >
            <!-- github -->
            <a
              href="https://github.com/NamTM-24"
              target="_blank"
              aria-label="Weaverse Github Org"
              class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600"
            >
              <svg
                class="w-5 h-5 text-white"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.438 9.8 8.205 11.387.6.111.82-.261.82-.579 0-.287-.011-1.046-.017-2.053-3.338.726-4.042-1.61-4.042-1.61-.546-1.386-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.085 1.839 1.237 1.839 1.237 1.07 1.835 2.807 1.304 3.492.997.108-.774.418-1.304.762-1.604-2.665-.305-5.467-1.333-5.467-5.931 0-1.31.469-2.381 1.236-3.221-.124-.303-.536-1.524.117-3.176 0 0 1.008-.323 3.3 1.23a11.51 11.51 0 013.004-.404c1.019.005 2.047.138 3.004.404 2.291-1.553 3.297-1.23 3.297-1.23.655 1.652.243 2.873.12 3.176.77.84 1.235 1.911 1.235 3.221 0 4.61-2.807 5.624-5.48 5.921.43.371.823 1.103.823 2.222 0 1.605-.015 2.896-.015 3.289 0 .321.216.694.825.576C20.565 21.797 24 17.309 24 12c0-6.63-5.37-12-12-12z"
                />
              </svg>
            </a>
            <!-- facebook -->
            <a
              href="https://www.facebook.com/hnt0024"
              target="_blank"
              aria-label="Visit our Facebook"
              class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 320 512"
                class="w-5 h-5 text-white fill-current"
              >
                <path
                  d="M279.14 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 
  52.24-50.06h40.42V6.26S293.48 0 267.5 0c-73.1 0-121.05 44.38-121.05 
  124.72V195.3H86.4V288h60.05v224h92.66V288z"
                />
              </svg>
            </a>

            <!-- gmail -->
            <a
              href="https://www.facebook.com/hnt0024"
              target="_blank"
              aria-label="Visit our Facebook"
              class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 512 512"
                class="w-5 h-5 text-white fill-current"
              >
                <path
                  d="M502.3 190.8L327.4 338.5c-17.7 14.8-43.6 14.8-61.3 0L9.7 190.8C3.7 186.1 0 178.8 0 171V48c0-26.5 21.5-48 48-48h416c26.5 0 48 21.5 48 48v123c0 7.8-3.7 15.1-9.7 19.8zM0 216v208c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48V216l-180.7 151c-35.3 29.6-85.5 29.6-120.8 0L0 216z"
                />
              </svg>
            </a>

            <!-- User Profile Dropdown -->
            <% if (user) { %>
            <div class="relative">
              <button
                id="user-menu-button"
                type="button"
                class="flex text-sm bg-gray-800 rounded-full focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600"
                aria-expanded="false"
              >
                <span class="sr-only">Open user menu</span>
                <% if (user.avatar) { %>
                <img
                  class="w-8 h-8 rounded-full"
                  src="<%= user.avatar %>"
                  alt="<%= user.name %>"
                />
                <% } else { %>
                <div
                  class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center"
                >
                  <span class="text-sm font-medium text-white"
                    ><%= user.name ? user.name.charAt(0).toUpperCase() : 'U'
                    %></span
                  >
                </div>
                <% } %>
              </button>
              <!-- Dropdown menu -->
              <div
                class="hidden absolute right-0 mt-2 z-50 text-base list-none bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700 dark:divide-gray-600"
                id="user-dropdown"
                style="min-width: 200px"
              >
                <div class="px-4 py-3">
                  <span class="block text-sm text-gray-900 dark:text-white"
                    ><%= user.name %></span
                  >
                  <span
                    class="block text-sm text-gray-500 truncate dark:text-gray-400"
                    ><%= user.email %></span
                  >
                </div>
                <ul class="py-2" aria-labelledby="user-menu-button">
                  <li>
                    <a
                      href="/user/profile/<%= user.id %>"
                      class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white"
                    >
                      <svg
                        class="w-4 h-4 inline mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        ></path>
                      </svg>
                      Hồ sơ của tôi
                    </a>
                  </li>
                  <% if (user.role === 'USER') { %>
                  <li>
                    <a
                      href="/posts/create/new"
                      class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white"
                    >
                      <svg
                        class="w-4 h-4 inline mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 4v16m8-8H4"
                        ></path>
                      </svg>
                      Viết bài
                    </a>
                  </li>
                  <li>
                    <a
                      href="/posts/user/manage"
                      class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white"
                    >
                      <svg
                        class="w-4 h-4 inline mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        ></path>
                      </svg>
                      Quản lý bài viết
                    </a>
                  </li>
                  <% } %> <% if (user.role === 'ADMIN') { %>
                  <li>
                    <a
                      href="/admin"
                      class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white"
                    >
                      <svg
                        class="w-4 h-4 inline mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2zm0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                        ></path>
                      </svg>
                      Quản lý admin
                    </a>
                  </li>
                  <% } %>
                  <li>
                    <button
                      type="button"
                      id="change-avatar-btn"
                      class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white"
                    >
                      <svg
                        class="w-4 h-4 inline mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        ></path>
                      </svg>
                      Thay đổi avatar
                    </button>
                  </li>
                  <li>
                    <a
                      href="/logout"
                      class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white"
                    >
                      <svg
                        class="w-4 h-4 inline mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        ></path>
                      </svg>
                      Đăng xuất
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <% } else { %>
            <a
              href="/login"
              class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600"
            >
              <svg
                class="w-5 h-5 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
            </a>
            <% } %>
          </div>

          <div
            class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1"
            id="navbar-user"
          >
            <ul
              class="flex flex-col font-medium p-4 md:p-0 mt-4 border border-gray-100 rounded-lg bg-gray-50 md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700"
            >
              <li>
                <a
                  href="/home"
                  class="block py-2 px-3 text-gray-900 rounded-sm hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700"
                  >Trang chủ</a
                >
              </li>
              <li>
                <a
                  href="/posts"
                  class="block py-2 px-3 text-gray-900 rounded-sm hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700"
                  >Bài viết</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="block py-2 px-3 text-gray-900 rounded-sm hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700"
                  >Lộ trình</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="block py-2 px-3 text-gray-900 rounded-sm hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700"
                  >Danh mục</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="block py-2 px-3 text-gray-900 rounded-sm hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700"
                  >Giới thiệu</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="block py-2 px-3 text-gray-900 rounded-sm hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700"
                  >Liên hệ</a
                >
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- MID -->
    <main class="pb-16 lg:pb-24 bg-white dark:bg-gray-900 antialiased">
      <header
        class="bg-[url('https://flowbite.s3.amazonaws.com/blocks/marketing-ui/articles/background.png')] w-full h-[460px] xl:h-[537px] bg-no-repeat bg-cover bg-center bg-blend-darken relative"
      >
        <div
          class="absolute top-0 left-0 w-full h-full bg-black bg-opacity-50"
        ></div>
        <div
          class="absolute top-20 left-1/2 px-4 mx-auto w-full max-w-screen-xl -translate-x-1/2 xl:top-1/2 xl:-translate-y-1/2 xl:px-0"
        >
          >
          <h1
            class="mb-4 max-w-4xl text-2xl font-extrabold leading-none text-white sm:text-3xl lg:text-4xl"
          >
            <%= post.title %>
          </h1>
          <p class="text-lg font-normal text-gray-300">
            <%= post.excerpt || 'Bài viết chất lượng từ StudyBlog' %>
          </p>
        </div>
      </header>
      <div
        class="flex relative z-20 justify-between p-6 -m-36 mx-4 max-w-screen-xl bg-white dark:bg-gray-800 rounded xl:-m-32 xl:p-9 xl:mx-auto"
      >
        <article
          class="xl:w-[828px] w-full max-w-none format format-sm sm:format-base lg:format-lg format-blue dark:format-invert"
        >
          <div
            class="flex flex-col lg:flex-row justify-between lg:items-center"
          >
            <div
              class="flex items-center space-x-3 text-gray-500 dark:text-gray-400 text-base mb-2 lg:mb-0"
            >
              <span
                >Tác giả
                <a
                  href="#"
                  class="text-gray-900 dark:text-white hover:underline no-underline font-semibold"
                  ><%= post.authorName %></a
                ></span
              >
              <span
                class="bg-gray-300 dark:bg-gray-400 w-2 h-2 rounded-full"
              ></span>
              <span
                ><time
                  class="font-normal text-gray-500 dark:text-gray-400"
                  pubdate
                  class="uppercase"
                  datetime="<%= post.publishedAtISO %>"
                  title="<%= post.prettyDate %>"
                  ><%= post.prettyDate %></time
                ></span
              >
            </div>
            <aside aria-label="Share social media">
              <div class="not-format">
                <button
                  data-tooltip-target="tooltip-facebook"
                  class="inline-flex items-center p-2 text-sm font-medium text-center text-gray-500 bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50 dark:bg-gray-800 dark:hover:bg-gray-700 dark:focus:ring-gray-600"
                  type="button"
                >
                  <svg
                    class="w-5 h-5 text-gray-500 dark:text-gray-400"
                    aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="currentColor"
                    viewBox="0 0 8 19"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M6.135 3H8V0H6.135a4.147 4.147 0 0 0-4.142 4.142V6H0v3h2v9.938h3V9h2.021l.592-3H5V3.591A.6.6 0 0 1 5.592 3h.543Z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
                <div
                  id="tooltip-facebook"
                  role="tooltip"
                  class="inline-block absolute invisible z-10 py-2 px-3 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm opacity-0 transition-opacity duration-300 tooltip dark:bg-gray-700"
                >
                  Share on Facebook
                  <div class="tooltip-arrow" data-popper-arrow></div>
                </div>

                <button
                  data-tooltip-target="tooltip-twitter"
                  class="inline-flex items-center p-2 text-sm font-medium text-center text-gray-500 bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50 dark:bg-gray-800 dark:hover:bg-gray-700 dark:focus:ring-gray-600"
                  type="button"
                >
                  <svg
                    class="w-5 h-5 text-gray-500 dark:text-gray-400"
                    aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill="currentColor"
                      d="M12.186 8.672 18.743.947h-2.927l-5.005 5.9-4.44-5.9H0l7.434 9.876-6.986 8.23h2.927l5.434-6.4 4.82 6.4H20L12.186 8.672Zm-2.267 2.671L8.544 9.515 3.2 2.42h2.2l4.312 5.719 1.375 1.828 5.731 7.613h-2.2l-4.699-6.237Z"
                    />
                  </svg>
                </button>
                <div
                  id="tooltip-twitter"
                  role="tooltip"
                  class="inline-block absolute invisible z-10 py-2 px-3 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm opacity-0 transition-opacity duration-300 tooltip dark:bg-gray-700"
                >
                  Share on Twitter
                  <div class="tooltip-arrow" data-popper-arrow></div>
                </div>

                <button
                  data-tooltip-target="tooltip-reddit"
                  class="inline-flex items-center p-2 text-sm font-medium text-center text-gray-500 bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50 dark:bg-gray-800 dark:hover:bg-gray-700 dark:focus:ring-gray-600"
                  type="button"
                >
                  <svg
                    class="w-5 h-5 text-gray-500 dark:text-gray-400"
                    aria-hidden="true"
                    viewBox="0 0 18 18"
                    fill="currentColor"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <g clip-path="url(#clip0_13676_82300)">
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M9 0C4.029 0 0 4.029 0 9s4.029 9 9 9 9-4.029 9-9-4.029-9-9-9zm0 1.125c4.347 0 7.875 3.528 7.875 7.875S13.347 17.875 9 17.875 1.125 14.347 1.125 10 4.653 1.125 9 1.125z"
                        fill="currentColor"
                      />
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M9 3.375c-1.125 0-2.25.563-2.25 1.688 0 .563.281 1.125.844 1.406.281.141.563.281.844.281.281 0 .563-.14.844-.281.563-.281.844-.843.844-1.406 0-.563-.281-1.125-.844-1.406C9.563 3.375 9.281 3.375 9 3.375zM6.75 6.75c0-.563.281-1.125.844-1.406.281-.141.563-.281.844-.281.281 0 .563.14.844.281.563.281.844.843.844 1.406 0 .563-.281 1.125-.844 1.406-.281.141-.563.281-.844.281-.281 0-.563-.14-.844-.281C7.031 7.875 6.75 7.313 6.75 6.75z"
                        fill="currentColor"
                      />
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M9 9.563c-1.125 0-2.25.563-2.25 1.688 0 .563.281 1.125.844 1.406.281.141.563.281.844.281.281 0 .563-.14.844-.281.563-.281.844-.843.844-1.406 0-.563-.281-1.125-.844-1.406C9.563 10.125 9.281 10.125 9 10.125z"
                        fill="currentColor"
                      />
                    </g>
                  </svg>
                </button>
                <div
                  id="tooltip-reddit"
                  role="tooltip"
                  class="inline-block absolute invisible z-10 py-2 px-3 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm opacity-0 transition-opacity duration-300 tooltip dark:bg-gray-700"
                >
                  Share on Reddit
                  <div class="tooltip-arrow" data-popper-arrow></div>
                </div>
              </div>
            </aside>
          </div>

          <!-- Article Content -->
          <div class="article-content"><%- post.lead %></div>

          <!-- BÌNH LUẬN (JavaScript - không reload trang) -->
          <section class="not-format">
            <div class="flex justify-between items-center mb-6">
              <h2
                class="text-lg lg:text-2xl font-bold text-gray-900 dark:text-white"
              >
                Bình luận
              </h2>
            </div>

            <!-- Form tạo comment mới -->
            <div class="mb-6">
              <div
                class="mb-4 w-full bg-gray-50 rounded-lg border border-gray-200 dark:bg-gray-700 dark:border-gray-600"
              >
                <div class="py-2 px-4 bg-gray-50 rounded-t-lg dark:bg-gray-800">
                  <label for="new-comment" class="sr-only">Your comment</label>
                  <textarea
                    id="new-comment"
                    rows="6"
                    class="px-0 w-full text-sm text-gray-900 bg-gray-50 border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400"
                    placeholder="Hãy viết bình luận của bạn..."
                  ></textarea>
                </div>
                <div
                  class="flex justify-between items-center py-2 px-3 border dark:border-gray-600"
                >
                  <button
                    type="button"
                    id="submit-comment"
                    class="inline-flex items-center py-2.5 px-4 text-xs font-medium text-center text-white dark:text-white bg-primary-700 rounded-lg focus:ring-4 focus:ring-primary-200 dark:focus:ring-primary-900 hover:bg-primary-800 border border-primary-700"
                  >
                    Đăng bình luận
                  </button>
                </div>
              </div>
            </div>

            <!-- Container hiển thị comments -->
            <div id="comments-container">
              <!-- Comments sẽ được load bằng JavaScript -->
              <div id="loading-comments" class="text-center py-8">
                <div
                  class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-700"
                ></div>
                <p class="mt-2 text-gray-600 dark:text-gray-400">
                  Đang tải bình luận...
                </p>
              </div>
              <div id="no-comments" class="text-center py-8 hidden">
                <p class="text-gray-600 dark:text-gray-400">
                  Chưa có bình luận nào. Hãy là người đầu tiên bình luận!
                </p>
              </div>
            </div>
          </section>
        </article>

        <!-- Sidebar -->
        <aside class="hidden xl:block" aria-labelledby="sidebar-label">
          <div class="xl:w-[336px] sticky top-6">
            <h3 id="sidebar-label" class="sr-only">Sidebar</h3>
            <div class="mb-12">
              <h4
                class="mb-4 text-sm font-bold text-gray-900 dark:text-white uppercase"
              >
                Tin tức mới
              </h4>
              <% if (relatedPosts && relatedPosts.length > 0) { %> <%
              relatedPosts.slice(0, 3).forEach((post, index) => { %>
              <div class="mb-6 flex items-center">
                <a href="<%= post.url %>" class="shrink-0">
                  <% if (post.heroImage) { %>
                  <img
                    src="<%= post.heroImage %>"
                    class="mr-4 max-w-full w-24 h-24 rounded-lg object-cover"
                    alt="<%= post.title %>"
                  />
                  <% } else { %>
                  <div
                    class="mr-4 w-24 h-24 rounded-lg bg-gradient-to-br from-slate-200 to-slate-300 dark:from-slate-700 dark:to-slate-600 flex items-center justify-center"
                  >
                    <span class="text-2xl text-slate-500 dark:text-slate-400"
                      >📄</span
                    >
                  </div>
                  <% } %>
                </a>
                <div>
                  <h5
                    class="mb-2 text-lg font-bold leading-tight dark:text-white text-gray-900"
                  >
                    <a href="<%= post.url %>" class="hover:underline"
                      ><%= post.title %></a
                    >
                  </h5>
                  <p class="mb-2 text-gray-500 dark:text-gray-400">
                    <%= post.excerpt %>
                  </p>
                  <a
                    href="<%= post.url %>"
                    class="inline-flex items-center font-medium underline underline-offset-4 text-primary-600 dark:text-primary-500 hover:no-underline"
                  >
                    Đọc bài
                  </a>
                </div>
              </div>
              <% }); %> <% } else { %>
              <div class="text-center py-8">
                <p class="text-gray-500 dark:text-gray-400">
                  Chưa có bài viết nào
                </p>
              </div>
              <% } %>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <aside
      aria-label="Related articles"
      class="py-8 lg:py-24 bg-white dark:bg-gray-900"
    >
      <div class="px-4 mx-auto max-w-screen-xl">
        <div class="mb-6 lg:mb-8">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
            Các bài viết khác
          </h2>
        </div>

        <% if (relatedPosts && relatedPosts.length > 0) { %>
        <div class="relative overflow-hidden">
          <div
            id="rel-track"
            class="flex gap-6 transition-transform duration-500 ease-out"
          >
            <% relatedPosts.forEach((post) => { %>
            <div class="w-full md:w-1/3 flex-shrink-0">
              <article
                class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 h-full hover:shadow-lg transition-all duration-300 hover:-translate-y-1"
              >
                <div class="flex flex-col h-full">
                  <a href="<%= post.url %>" class="block mb-4">
                    <% if (post.heroImage) { %>
                    <img
                      src="<%= post.heroImage %>"
                      class="w-full h-48 object-cover rounded-lg"
                      alt="<%= post.title %>"
                    />
                    <% } else { %>
                    <div
                      class="w-full h-48 rounded-lg bg-gradient-to-br from-slate-200 to-slate-300 dark:from-slate-700 dark:to-slate-600 flex items-center justify-center"
                    >
                      <span class="text-6xl text-slate-500 dark:text-slate-400"
                        >📄</span
                      >
                    </div>
                    <% } %>
                  </a>
                  <div class="flex-1 flex flex-col">
                    <h3
                      class="text-lg font-semibold text-gray-900 dark:text-white mb-3 line-clamp-2 leading-tight"
                    >
                      <a
                        href="<%= post.url %>"
                        class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                      >
                        <%= post.title.length > 60 ? post.title.substring(0, 60)
                        + '...' : post.title %>
                      </a>
                    </h3>
                    <p
                      class="text-gray-600 dark:text-gray-400 mb-4 line-clamp-3 text-sm leading-relaxed flex-1"
                    >
                      <%= post.excerpt && post.excerpt.length > 100 ?
                      post.excerpt.substring(0, 100) + '...' : (post.excerpt ||
                      'Đọc bài viết để khám phá nội dung thú vị...') %>
                    </p>
                    <div
                      class="flex items-center justify-between pt-3 border-t border-gray-100 dark:border-gray-700"
                    >
                      <span class="text-xs text-gray-500 dark:text-gray-400">
                        <%= post.prettyDate || '15/1/2025' %>
                      </span>
                      <a
                        href="<%= post.url %>"
                        class="inline-flex items-center text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                      >
                        Đọc bài
                        <svg
                          class="w-4 h-4 ml-1"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5l7 7-7 7"
                          ></path>
                        </svg>
                      </a>
                    </div>
                  </div>
                </div>
              </article>
            </div>
            <% }) %>
          </div>
        </div>

        <% if (relatedPosts && relatedPosts.length > 3) { %>
        <div class="flex items-center justify-center mt-8 space-x-4">
          <button
            id="rel-prev"
            class="inline-flex items-center justify-center p-2 rounded-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition-colors duration-200"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              ></path>
            </svg>
          </button>
          <span id="rel-page" class="text-sm text-gray-600 dark:text-gray-400"
            >Trang 1 / 1</span
          >
          <button
            id="rel-next"
            class="inline-flex items-center justify-center p-2 rounded-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition-colors duration-200"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </button>
        </div>
        <% } %> <% } else { %>
        <div class="text-center py-12">
          <p class="text-gray-500 dark:text-gray-400">
            Chưa có bài viết nào khác
          </p>
        </div>
        <% } %>
      </div>
    </aside>

    <style>
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .related-post-card {
        transition: all 0.3s ease;
      }

      .title-truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    </style>

    <script>
      (function () {
        const track = document.getElementById("rel-track");
        if (!track) return;
        const prevBtn = document.getElementById("rel-prev");
        const nextBtn = document.getElementById("rel-next");
        const pageEl = document.getElementById("rel-page");

        let currentIndex = 0;
        let itemsPerView = 1; // Default for mobile

        function updateItemsPerView() {
          itemsPerView = window.innerWidth >= 768 ? 3 : 1;
        }

        function updateCarousel() {
          updateItemsPerView();
          const itemWidth = track.children[0]
            ? track.children[0].offsetWidth + 24
            : 0; // + gap-6 (24px)
          const offset = -currentIndex * itemWidth;
          track.style.transform = `translateX(${offset}px)`;

          const totalItems = track.children.length;
          const totalPages = Math.ceil(totalItems / itemsPerView);
          const currentPage = Math.floor(currentIndex / itemsPerView) + 1;

          if (pageEl) {
            pageEl.textContent = `Trang ${currentPage} / ${totalPages}`;
          }

          if (prevBtn) {
            prevBtn.disabled = currentIndex === 0;
          }
          if (nextBtn) {
            nextBtn.disabled = currentIndex + itemsPerView >= totalItems;
          }
        }

        if (prevBtn) {
          prevBtn.addEventListener("click", () => {
            currentIndex = Math.max(0, currentIndex - itemsPerView);
            updateCarousel();
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener("click", () => {
            const totalItems = track.children.length;
            currentIndex = Math.min(
              totalItems - itemsPerView,
              currentIndex + itemsPerView
            );
            updateCarousel();
          });
        }

        window.addEventListener("resize", updateCarousel);
        updateCarousel(); // Initial call
      })();
    </script>

    <script>
      // Comment functionality
      const commentForm = document.getElementById("commentForm");
      const commentContent = document.getElementById("commentContent");

      if (commentForm) {
        commentForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const content = commentContent.value.trim();
          if (!content) return;

          try {
            const response = await fetch(
              "/api/posts/<%= post.slug %>/comments",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ content }),
              }
            );

            if (response.ok) {
              const result = await response.json();
              // Reload page to show new comment
              window.location.reload();
            } else {
              alert("Không thể gửi bình luận. Vui lòng thử lại.");
            }
          } catch (error) {
            console.error("Error posting comment:", error);
            alert("Có lỗi xảy ra. Vui lòng thử lại.");
          }
        });
      }

      // Reply functionality
      document.querySelectorAll(".reply-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const commentId = this.getAttribute("data-comment-id");
          const commentDiv = this.closest(".comment");

          // Remove existing reply form
          const existingForm = commentDiv.querySelector(".reply-form");
          if (existingForm) {
            existingForm.remove();
            return;
          }

          // Create reply form
          const replyForm = document.createElement("div");
          replyForm.className = "reply-form mt-3 ml-6";
          replyForm.innerHTML = `
          <form class="space-y-2">
            <textarea 
              placeholder="Viết trả lời..."
              class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white"
              rows="2"
            ></textarea>
            <div class="flex space-x-2">
              <button 
                type="submit"
                class="px-3 py-1 bg-blue-600 text-white dark:text-white rounded text-sm hover:bg-blue-700 transition"
              >
                Trả lời
              </button>
              <button 
                type="button"
                class="px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm hover:bg-gray-400 transition cancel-reply"
              >
                Hủy
              </button>
            </div>
          </form>
        `;

          commentDiv.appendChild(replyForm);

          // Handle reply form submission
          const form = replyForm.querySelector("form");
          const textarea = replyForm.querySelector("textarea");
          const cancelBtn = replyForm.querySelector(".cancel-reply");

          form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const content = textarea.value.trim();
            if (!content) return;

            try {
              const response = await fetch(
                "/api/posts/<%= post.slug %>/comments",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ content, parentId: commentId }),
                }
              );

              if (response.ok) {
                window.location.reload();
              } else {
                alert("Không thể gửi trả lời. Vui lòng thử lại.");
              }
            } catch (error) {
              console.error("Error posting reply:", error);
              alert("Có lỗi xảy ra. Vui lòng thử lại.");
            }
          });

          cancelBtn.addEventListener("click", () => {
            replyForm.remove();
          });
        });
      });
    </script>

    <!-- Load Comment System -->
    <script src="/js/comment-system.js"></script>
    <script src="/js/chat-widget.js"></script>
    <script>
      // Initialize comment system for post page
      document.addEventListener('DOMContentLoaded', function() {
        commentSystem = new CommentSystem({
          currentUser: <%- JSON.stringify(user || null) %>,
          currentPostSlug: '<%= post.slug %>',
          apiBase: '/api/posts'
        });

        // User dropdown functionality
        const userMenuButton = document.getElementById('user-menu-button');
        const userDropdown = document.getElementById('user-dropdown');

        console.log('=== Avatar Dropdown Debug ===');
        console.log('userMenuButton:', userMenuButton);
        console.log('userDropdown:', userDropdown);

        if (userMenuButton && userDropdown) {
          console.log('Attaching click event to user menu button');
          userMenuButton.addEventListener('click', (e) => {
            console.log('User menu button clicked!');
            e.preventDefault();
            e.stopPropagation();
            userDropdown.classList.toggle('hidden');
            console.log('Dropdown hidden class:', userDropdown.classList.contains('hidden'));
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!userMenuButton.contains(e.target) && !userDropdown.contains(e.target)) {
              userDropdown.classList.add('hidden');
            }
          });
        } else {
          console.log('User menu button or dropdown not found!');
        }

        // Avatar modal functionality - Hashnode Style
        const changeAvatarBtn = document.getElementById('change-avatar-btn');
        const avatarModal = document.getElementById('avatar-modal');
        const closeAvatarModal = document.getElementById('close-avatar-modal');

        console.log('=== Avatar Modal Debug ===');
        console.log('changeAvatarBtn:', changeAvatarBtn);
        console.log('avatarModal:', avatarModal);
        const cancelAvatarBtn = document.getElementById('cancel-avatar-btn');
        const selectAvatarBtn = document.getElementById('select-avatar-btn');
        const saveAvatarBtn = document.getElementById('save-avatar-btn');
        const avatarInput = document.getElementById('avatar-input');
        const avatarPreview = document.getElementById('avatar-preview');
        const avatarPlaceholder = document.getElementById('avatar-placeholder');

        let selectedFile = null;

        // Open modal when clicking "Thay đổi avatar"
        if (changeAvatarBtn) {
          changeAvatarBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            avatarModal.classList.remove('hidden');
            // Close dropdown
            userDropdown.classList.add('hidden');
          });
        }

        // Close modal functions
        function closeModal() {
          avatarModal.classList.add('hidden');
          selectedFile = null;
          avatarInput.value = '';
          avatarPreview.classList.add('hidden');
          avatarPlaceholder.classList.remove('hidden');
          saveAvatarBtn.disabled = true;
        }

        if (closeAvatarModal) {
          closeAvatarModal.addEventListener('click', closeModal);
        }

        if (cancelAvatarBtn) {
          cancelAvatarBtn.addEventListener('click', closeModal);
        }

        // Close modal when clicking outside
        avatarModal.addEventListener('click', (e) => {
          if (e.target === avatarModal) {
            closeModal();
          }
        });

        // Select file button
        if (selectAvatarBtn) {
          selectAvatarBtn.addEventListener('click', () => {
            avatarInput.click();
          });
        }

        // Handle file selection
        if (avatarInput) {
          avatarInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            selectedFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
              avatarPreview.src = e.target.result;
              avatarPreview.classList.remove('hidden');
              avatarPlaceholder.classList.add('hidden');
              saveAvatarBtn.disabled = false;
            };
            reader.readAsDataURL(file);
          });
        }

        // Save avatar
        if (saveAvatarBtn) {
          saveAvatarBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('avatar', selectedFile);

            try {
              const response = await fetch('/api/upload-avatar', {
                method: 'POST',
                body: formData
              });

              if (response.ok) {
                const result = await response.json();

                // Update avatar in UI
                const userMenuButton = document.getElementById('user-menu-button');
                if (userMenuButton) {
                  userMenuButton.innerHTML = `
                    <span class="sr-only">Open user menu</span>
                    <img class="w-8 h-8 rounded-full" src="${result.avatar}" alt="User avatar">
                  `;
                  // Re-attach click event
                  userMenuButton.addEventListener('click', () => {
                    userDropdown.classList.toggle('hidden');
                  });
                }

                // Close modal
                closeModal();

                console.log('Avatar updated successfully!');
              } else {
                const errorText = await response.text();
                throw new Error(`Upload failed: ${response.status} - ${errorText}`);
              }
            } catch (error) {
              console.error('Upload error:', error);
              alert('Không thể tải avatar lên. Vui lòng thử lại. Lỗi: ' + error.message);
            }
          });
        }
      });
    </script>

    <!-- Avatar Change Modal - Hashnode Style -->
    <div
      id="avatar-modal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            Profile Image
          </h3>
          <button
            id="close-avatar-modal"
            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <div class="flex items-center space-x-4 mb-6">
          <div
            class="w-20 h-20 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center overflow-hidden"
          >
            <img
              id="avatar-preview"
              src=""
              alt="Avatar preview"
              class="w-full h-full object-cover hidden"
            />
            <div
              id="avatar-placeholder"
              class="w-full h-20 bg-gray-300 dark:bg-gray-600 flex items-center justify-center"
            >
              <svg
                class="w-8 h-8 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
            </div>
          </div>
          <div class="flex-1">
            <button
              id="select-avatar-btn"
              class="bg-blue-600 hover:bg-blue-700 text-white dark:text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                ></path>
              </svg>
              <span>Change Image</span>
            </button>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
              PNG, JPEG: 500 x 500 px
            </p>
          </div>
        </div>

        <div class="flex justify-end space-x-3">
          <button
            id="cancel-avatar-btn"
            class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors"
          >
            Cancel
          </button>
          <button
            id="save-avatar-btn"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white dark:text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Save
          </button>
        </div>

        <input type="file" id="avatar-input" accept="image/*" class="hidden" />
      </div>
    </div>
  </body>
</html>
